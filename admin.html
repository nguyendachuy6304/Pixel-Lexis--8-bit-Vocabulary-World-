<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Pixel Lexis - Admin Zone</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Giao di·ªán ri√™ng cho Admin */
        .admin-container { max-width: 800px; margin: 0 auto; padding: 20px; border-color: #4caf50; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; color: #ffcc00; margin-bottom: 5px; font-size: 24px; }
        select, input { 
            width: 100%; padding: 10px; font-family: 'VT323'; font-size: 22px; 
            background: #333; color: #fff; border: 2px solid #fff; box-sizing: border-box;
        }
        .question-list { border: 2px dashed #555; padding: 15px; margin-bottom: 20px; background: #222; min-height: 50px;}
        .q-item { display: flex; gap: 10px; margin-bottom: 10px; }
        .game-header h1 { color: #4caf50; }
        
        /* Style th√¥ng b√°o l·ªói */
        #error-log { color: #ff5555; background: #220000; padding: 10px; display: none; border: 1px solid red; font-family: monospace; font-size: 16px; margin-bottom: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="game-container admin-container">
        <header class="game-header">
            <h1>ADMIN CONTROL</h1>
            <p>Khu v·ª±c d√†nh ri√™ng cho Gi√°o Vi√™n</p>
        </header>

        <div id="error-log"></div>

        <div class="form-group">
            <label>1. Ch·ªçn V√πng ƒê·∫•t (World):</label>
            <select id="world-select">
                <option value="map_rung">üå≤ R·ª´ng Kh·ªüi ƒê·∫ßu</option>
                <option value="map_city">üèôÔ∏è Th√†nh Ph·ªë Code</option>
                <option value="map_dungeon">üíÄ H·∫ßm Ng·ª•c T·ªëi</option>
            </select>
        </div>

        <div class="form-group">
            <label>2. Th√¥ng tin Level:</label>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="level-id" placeholder="ID (V√≠ d·ª•: 1)" style="width: 100px;">
                <input type="text" id="level-name" placeholder="T√™n m√†n (V√≠ d·ª•: B√¨a R·ª´ng)">
            </div>
            <div style="margin-top: 10px;">
                <input type="checkbox" id="is-boss" style="width: 20px; height: 20px;"> 
                <span style="font-size: 20px; color: #d32f2f; vertical-align: bottom;">ƒê√¢y l√† m√†n BOSS?</span>
            </div>
        </div>

        <div class="form-group">
            <label>3. Danh s√°ch t·ª´ v·ª±ng:</label>
            <div id="q-container" class="question-list">
                </div>
            <button class="pixel-btn secondary small" id="btn-add-line">+ Th√™m t·ª´ m·ªõi</button>
        </div>

        <button class="pixel-btn" id="btn-save" style="background-color: #4caf50;">L∆ØU L√äN CLOUD ‚òÅÔ∏è</button>
        <p id="status-msg" style="margin-top: 15px; font-size: 20px;"></p>
        
        <br>
        <button class="pixel-btn secondary" id="btn-logout" style="background-color: #d32f2f;">‚¨Ö ƒêƒÇNG XU·∫§T</button>
    </div>

    <script>
        function logError(msg) {
            const errDiv = document.getElementById('error-log');
            errDiv.style.display = 'block';
            errDiv.innerText += "L·ªñI: " + msg + "\n";
        }

        function addQuestionLine() {
            const div = document.createElement("div");
            div.className = "q-item";
            div.innerHTML = `
                <input type="text" placeholder="Ti·∫øng Anh (WORD)" class="inp-word">
                <input type="text" placeholder="Ti·∫øng Vi·ªát (MEANING)" class="inp-meaning">
            `;
            document.getElementById("q-container").appendChild(div);
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                addQuestionLine(); addQuestionLine(); addQuestionLine();
                document.getElementById("btn-add-line").addEventListener("click", addQuestionLine);
            } catch (e) {
                logError(e.message);
            }
        });
    </script>

    <script type="module">
        // Import ƒë·∫ßy ƒë·ªß c√°c c√¥ng c·ª• c·∫ßn thi·∫øt: DB v√† Auth
        import { db, doc, setDoc, auth, signOut, onAuthStateChanged } from './js/firebase-init.js';

        // 1. NG∆Ø·ªúI G√ÅC C·ªîNG (Security Check)
        // Ki·ªÉm tra ngay khi v√†o trang: C√≥ ph·∫£i gi√°o vi√™n kh√¥ng?
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Ch√†o m·ª´ng Admin:", user.email);
            } else {
                // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -> ƒê·∫©y v·ªÅ trang Login ngay l·∫≠p t·ª©c
                alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
                window.location.href = "login.html";
            }
        });

        // 2. CH·ª®C NƒÇNG ƒêƒÇNG XU·∫§T
        document.getElementById("btn-logout").addEventListener("click", () => {
            if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) {
                signOut(auth).then(() => {
                    window.location.href = "login.html";
                }).catch((error) => {
                    alert("L·ªói khi ƒëƒÉng xu·∫•t: " + error.message);
                });
            }
        });

        // 3. CH·ª®C NƒÇNG L∆ØU D·ªÆ LI·ªÜU (Save Logic)
        document.getElementById("btn-save").addEventListener("click", async () => {
            const btn = document.getElementById("btn-save");
            const msg = document.getElementById("status-msg");
            
            btn.disabled = true;
            btn.innerText = "ƒêANG ƒê·∫®Y D·ªÆ LI·ªÜU...";
            msg.innerText = "";

            try {
                if (!db) throw new Error("M·∫•t k·∫øt n·ªëi Firebase!");

                const worldId = document.getElementById("world-select").value; 
                const levelId = document.getElementById("level-id").value;     
                const levelName = document.getElementById("level-name").value; 
                const isBoss = document.getElementById("is-boss").checked;

                const questions = [];
                document.querySelectorAll(".q-item").forEach(item => {
                    const w = item.querySelector(".inp-word").value.trim();
                    const m = item.querySelector(".inp-meaning").value.trim();
                    if(w && m) questions.push({ word: w.toUpperCase(), meaning: m });
                });

                if(!levelId || !levelName || questions.length === 0) {
                    throw new Error("Vui l√≤ng nh·∫≠p ID, T√™n m√†n v√† √≠t nh·∫•t 1 t·ª´ v·ª±ng!");
                }

                const docData = {
                    id: parseInt(levelId),
                    name: levelName,
                    isBoss: isBoss,
                    locked: parseInt(levelId) !== 1, 
                    completed: false,
                    questions: questions
                };

                // L∆∞u v√†o Firestore
                await setDoc(doc(db, "worlds", worldId, "levels", levelId), docData);

                msg.innerText = "‚úÖ TH√ÄNH C√îNG! D·ªØ li·ªáu ƒë√£ l√™n m√¢y.";
                msg.style.color = "#4caf50";
                
            } catch (error) {
                console.error(error);
                msg.innerText = "‚ùå L·ªñI: " + error.message;
                msg.style.color = "red";
                document.getElementById('error-log').style.display = 'block';
                document.getElementById('error-log').innerText = "Chi ti·∫øt l·ªói: " + error.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "L∆ØU L√äN CLOUD ‚òÅÔ∏è";
            }
        });
    </script>
</body>
</html>