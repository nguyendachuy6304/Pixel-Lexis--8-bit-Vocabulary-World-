<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Pixel Lexis - Admin Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container { max-width: 900px; margin: 0 auto; padding: 20px; border-color: #4caf50; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; color: #ffcc00; margin-bottom: 5px; font-size: 24px; }
        select, input { width: 100%; padding: 10px; font-family: 'VT323'; font-size: 22px; background: #333; color: #fff; border: 2px solid #fff; box-sizing: border-box; }
        .game-header h1 { color: #4caf50; }
        .manage-list { margin-top: 10px; max-height: 300px; overflow-y: auto; border: 2px solid #555; padding: 10px; background: #222; }
        .list-item { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 10px; margin-bottom: 5px; border: 1px solid #777; }
        .list-item:hover { border-color: #fff; }
        .q-item { border: 1px dashed #666; padding: 15px; margin-bottom: 15px; background: #2a2a2a; position: relative; }
        .delete-q-btn { position: absolute; top: 5px; right: 5px; background: #d32f2f; border: 1px solid #fff; color: #fff; cursor: pointer; }
    </style>
</head>
<body>
    <div class="game-container admin-container">
        <header class="game-header">
            <h1>ADMIN CONTROL PRO</h1>
            <p>Qu·∫£n l√Ω & So·∫°n th·∫£o b√†i ki·ªÉm tra</p>
        </header>

        <button class="pixel-btn secondary" id="btn-logout" style="background-color: #d32f2f; float: right;">ƒêƒÇNG XU·∫§T</button>
        <div style="clear: both;"></div>
        <div id="error-log" style="color: red; display: none;"></div>

        <div class="form-group" style="border-bottom: 2px dashed #555; padding-bottom: 20px;">
            <label>üìÇ QU·∫¢N L√ù B√ÄI C≈®</label>
            <select id="world-select-manage">
                <option value="map_rung">üå≤ R·ª´ng Kh·ªüi ƒê·∫ßu</option>
                <option value="map_city">üèôÔ∏è Th√†nh Ph·ªë Code</option>
                <option value="map_dungeon">üíÄ H·∫ßm Ng·ª•c T·ªëi</option>
            </select>
            <button class="pixel-btn small" id="btn-load-list" style="margin-top: 10px;">T·∫¢I DANH S√ÅCH B√ÄI</button>
            <div id="level-list-container" class="manage-list"><p style="color: #aaa; text-align: center;">Ch∆∞a t·∫£i danh s√°ch...</p></div>
        </div>

        <h2 style="color: #4caf50; border-top: 2px solid #fff; padding-top: 20px;">üìù SO·∫†N TH·∫¢O B√ÄI H·ªåC</h2>
        
        <div class="form-group">
            <label>1. Th√¥ng tin Level:</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="number" id="level-id" placeholder="ID" style="width: 100px;">
                <input type="text" id="level-name" placeholder="T√™n b√†i h·ªçc">
            </div>
            
            <label style="font-size: 20px; color: #00e5ff;">ƒê·ªô kh√≥ m√†n ch∆°i (HP Qu√°i):</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" id="level-difficulty" min="1" max="10" value="1" oninput="document.getElementById('diff-val').innerText = this.value">
                <span id="diff-val" style="font-size: 24px; color: #ffeb3b; font-weight: bold;">1</span>
                <span style="color: #aaa;">(Level 1 = 100 HP, Level 10 = 1000 HP)</span>
            </div>

            <div style="margin-top: 10px;">
                <input type="checkbox" id="is-boss" style="width: 20px;"> 
                <span style="font-size: 20px; color: #d32f2f;">L√† m√†n BOSS?</span>
            </div>
        </div>

        <div class="form-group">
            <label>2. Danh s√°ch c√¢u h·ªèi:</label>
            <div id="q-container" class="question-list"></div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="pixel-btn secondary small" onclick="addQuestion('writing')">+ Vi·∫øt</button>
                <button class="pixel-btn secondary small" onclick="addQuestion('fill')">+ ƒêi·ªÅn t·ª´</button>
                <button class="pixel-btn secondary small" onclick="addQuestion('mc')">+ Tr·∫Øc nghi·ªám</button>
            </div>
        </div>

        <button class="pixel-btn" id="btn-save" style="background-color: #4caf50; width: 100%;">L∆ØU D·ªÆ LI·ªÜU ‚òÅÔ∏è</button>
        <p id="status-msg" style="margin-top: 15px; font-size: 20px; text-align: center;"></p>
    </div>

    <script type="module">
        import { db, collection, doc, setDoc, getDocs, deleteDoc, auth, onAuthStateChanged, signOut } from './js/firebase-init.js';

        onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "login.html"; });
        document.getElementById("btn-logout").addEventListener("click", () => signOut(auth).then(() => window.location.href = "login.html"));

        // --- H√ÄM T·∫¢I DANH S√ÅCH ---
        document.getElementById("btn-load-list").addEventListener("click", async () => {
            const worldId = document.getElementById("world-select-manage").value;
            const container = document.getElementById("level-list-container");
            container.innerHTML = "‚è≥ ƒêang t·∫£i...";
            try {
                const querySnapshot = await getDocs(collection(db, "worlds", worldId, "levels"));
                const levels = [];
                querySnapshot.forEach((doc) => levels.push(doc.data()));
                levels.sort((a, b) => a.id - b.id);
                container.innerHTML = "";
                levels.forEach(level => {
                    const diff = level.levelDifficulty || 1;
                    const div = document.createElement("div");
                    div.className = "list-item";
                    div.innerHTML = `
                        <div class="item-info">
                            <span style="color: #ffcc00;">ID ${level.id}:</span> ${level.name} 
                            <small style="color: #00e5ff;">(Lv.${diff})</small>
                        </div>
                        <div class="item-actions"><button class="pixel-btn small" id="edit-${level.id}">S·ª¨A</button><button class="pixel-btn small" style="background:#d32f2f;" id="del-${level.id}">X√ìA</button></div>
                    `;
                    container.appendChild(div);
                    document.getElementById(`edit-${level.id}`).addEventListener("click", () => loadLevelToForm(level));
                    document.getElementById(`del-${level.id}`).addEventListener("click", () => deleteLevel(worldId, level.id));
                });
            } catch (error) { container.innerText = "‚ùå L·ªói: " + error.message; }
        });

        async function deleteLevel(worldId, levelId) {
            if(confirm(`X√≥a Level ${levelId}?`)) {
                await deleteDoc(doc(db, "worlds", worldId, "levels", levelId.toString()));
                document.getElementById("btn-load-list").click();
            }
        }

        function loadLevelToForm(level) {
            document.getElementById("level-id").value = level.id;
            document.getElementById("level-name").value = level.name;
            document.getElementById("is-boss").checked = level.isBoss;
            
            // Load ƒë·ªô kh√≥ (M·∫∑c ƒë·ªãnh l√† 1 n·∫øu b√†i c≈© ch∆∞a c√≥)
            const diff = level.levelDifficulty || 1;
            document.getElementById("level-difficulty").value = diff;
            document.getElementById("diff-val").innerText = diff;

            document.getElementById("q-container").innerHTML = "";
            level.questions.forEach(q => {
                addQuestion(q.type); 
                const items = document.querySelectorAll(".q-item");
                const lastItem = items[items.length - 1];
                lastItem.querySelector(".inp-question").value = q.question;
                lastItem.querySelector(".inp-correct").value = q.correct;
                lastItem.querySelector(".inp-difficulty").value = q.difficulty || 1; 
                if (q.type === 'mc') {
                    lastItem.querySelector(".inp-opt-a").value = q.options[0];
                    lastItem.querySelector(".inp-opt-b").value = q.options[1];
                    lastItem.querySelector(".inp-opt-c").value = q.options[2];
                    lastItem.querySelector(".inp-opt-d").value = q.options[3];
                }
            });
            alert(`ƒê√£ t·∫£i b√†i "${level.name}".`);
        }

        window.addQuestion = function(type) {
            const container = document.getElementById("q-container");
            const div = document.createElement("div");
            div.className = "q-item";
            
            let html = `<button class="delete-q-btn" onclick="this.parentElement.remove()">X</button>`;
            html += `<div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                        <span style="color: #4caf50;">D·∫†NG: ${type.toUpperCase()}</span>
                        <select class="inp-difficulty" style="width: 150px; font-size: 18px; padding: 2px;">
                            <option value="1">‚≠ê D·ªÖ</option>
                            <option value="2">‚≠ê‚≠ê Th∆∞·ªùng</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Kh√≥</option>
                        </select>
                        <input type="hidden" class="inp-type" value="${type}">
                     </div>`;
            html += `<input type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." class="inp-question" style="margin-bottom: 5px;">`;

            if (type === 'mc') {
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                        <input type="text" placeholder="A" class="inp-opt-a"><input type="text" placeholder="B" class="inp-opt-b">
                        <input type="text" placeholder="C" class="inp-opt-c"><input type="text" placeholder="D" class="inp-opt-d">
                    </div>
                    <input type="text" placeholder="ƒê√°p √°n ƒë√∫ng (A/B/C/D)" class="inp-correct" style="margin-top: 5px; border-color: #4caf50;">`;
            } else {
                html += `<input type="text" placeholder="ƒê√°p √°n ƒë√∫ng" class="inp-correct" style="border-color: #4caf50;">`;
            }
            div.innerHTML = html;
            container.appendChild(div);
        };

        // --- L∆ØU D·ªÆ LI·ªÜU ---
        document.getElementById("btn-save").addEventListener("click", async () => {
            const btn = document.getElementById("btn-save");
            btn.disabled = true;
            try {
                const worldId = document.getElementById("world-select-manage").value; 
                const levelId = document.getElementById("level-id").value;
                const levelName = document.getElementById("level-name").value;
                const isBoss = document.getElementById("is-boss").checked;
                
                // L·∫§Y GI√Å TR·ªä ƒê·ªò KH√ì LEVEL
                const levelDifficulty = parseInt(document.getElementById("level-difficulty").value);

                const questions = [];
                document.querySelectorAll(".q-item").forEach(item => {
                    const type = item.querySelector(".inp-type").value;
                    const question = item.querySelector(".inp-question").value.trim();
                    const correct = item.querySelector(".inp-correct").value.trim().toUpperCase();
                    const difficulty = parseInt(item.querySelector(".inp-difficulty").value); 

                    if(question && correct) {
                        let qData = { type, question, correct, difficulty };
                        if (type === 'mc') {
                            qData.options = [
                                item.querySelector(".inp-opt-a").value.trim(), item.querySelector(".inp-opt-b").value.trim(),
                                item.querySelector(".inp-opt-c").value.trim(), item.querySelector(".inp-opt-d").value.trim()
                            ];
                        }
                        questions.push(qData);
                    }
                });

                if(!levelId || questions.length === 0) throw new Error("Thi·∫øu d·ªØ li·ªáu!");
                
                const docData = { 
                    id: parseInt(levelId), 
                    name: levelName, 
                    isBoss: isBoss, 
                    levelDifficulty: levelDifficulty, // L∆∞u th√™m tr∆∞·ªùng n√†y
                    locked: parseInt(levelId) !== 1, 
                    completed: false, 
                    questions: questions 
                };
                
                await setDoc(doc(db, "worlds", worldId, "levels", levelId), docData);
                document.getElementById("status-msg").innerText = "‚úÖ ƒê√É L∆ØU!";
                document.getElementById("btn-load-list").click();
            } catch (error) { document.getElementById("status-msg").innerText = "‚ùå L·ªói: " + error.message; }
            finally { btn.disabled = false; }
        });
    </script>
</body>
</html>