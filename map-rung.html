<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map: R·ª´ng Kh·ªüi ƒê·∫ßu</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="game-container">
        <header class="game-header">
            <h1>üå≤ R·ª™NG KH·ªûI ƒê·∫¶U üå≤</h1>
            <p>Level 1: Nh·∫≠p m√¥n</p>
        </header>

        <div id="map-screen">
            <div class="home-btn-container">
                <button class="pixel-btn secondary small" onclick="window.location.href='index.html'">‚¨Ö V·ªÄ TRANG CH·ª¶</button>
            </div>
            <div class="map-grid" id="level-list" style="color: #ffcc00;">
                ‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√¢y...
            </div>
        </div>

        <main id="battle-screen" class="hidden">
            <button id="btn-pause-toggle" class="pixel-btn">‚è∏ MENU</button>

            <div id="pause-modal" class="hidden">
                <div class="pause-content">
                    <h2>T·∫†M D·ª™NG</h2>
                    <button id="btn-resume" class="pixel-btn">TI·∫æP T·ª§C</button>
                    <button id="btn-restart" class="pixel-btn">CH∆†I L·∫†I</button>
                    <button id="btn-menu-map" class="pixel-btn secondary">THO√ÅT RA B·∫¢N ƒê·ªí</button>
                    <button id="btn-menu-home" class="pixel-btn secondary">V·ªÄ TRANG CH·ª¶</button>
                </div>
            </div>

            <div class="status-bar">
                <div class="player-stats">
                    <span>HERO</span>
                    <div class="hp-bar"><div class="hp-fill" id="hero-hp" style="width: 100%;"></div></div>
                </div>
                <div class="monster-stats">
                    <span id="monster-name">MONSTER</span>
                    <div class="hp-bar"><div class="hp-fill" id="monster-hp" style="width: 100%;"></div></div>
                </div>
            </div>

            <div class="monster-area">
                <div class="pixel-monster">üëæ</div>
            </div>

            <div class="dialog-box">
                <p id="question-text">...</p>
            </div>

            <div class="player-actions">
                <input type="text" class="pixel-input" placeholder="NH·∫¨P ƒê√ÅP √ÅN...">
                <button class="pixel-btn" id="btn-attack">T·∫§N C√îNG</button>
            </div>
            
            <button class="pixel-btn secondary hidden" id="btn-back-map" style="margin-top: 10px;">QUAY V·ªÄ B·∫¢N ƒê·ªí</button>
        </main>
    </div>

    <script src="js/core.js"></script>

    <script type="module">
        import { db, collection, getDocs } from './js/firebase-init.js';

        async function loadData() {
            try {
                // Tr·ªè t·ªõi th∆∞ m·ª•c: worlds -> map_rung -> levels
                const querySnapshot = await getDocs(collection(db, "worlds", "map_rung", "levels"));
                
                const levels = [];
                querySnapshot.forEach((doc) => {
                    levels.push(doc.data());
                });

                // S·∫Øp x·∫øp level theo ID (1, 2, 3...)
                levels.sort((a, b) => a.id - b.id);

                if (levels.length > 0) {
                    // G·ªçi h√†m initMap trong core.js ƒë·ªÉ v·∫Ω giao di·ªán
                    // (L∆∞u bi·∫øn levels v√†o window ƒë·ªÉ core.js d√πng l·∫°i khi c·∫ßn)
                    window.currentMapLevels = levels; 
                    initMap(levels);
                } else {
                    document.getElementById("level-list").innerText = "‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu tr√™n Cloud!";
                }

            } catch (error) {
                console.error("L·ªói t·∫£i map:", error);
                document.getElementById("level-list").innerText = "‚ùå L·ªói k·∫øt n·ªëi: " + error.message;
            }
        }

        // Ch·∫°y h√†m t·∫£i d·ªØ li·ªáu
        loadData();
    </script>
</body>
</html>