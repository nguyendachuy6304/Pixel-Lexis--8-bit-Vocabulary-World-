<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map: R·ª´ng Kh·ªüi ƒê·∫ßu</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* T√πy ch·ªânh nh·ªè ƒë·ªÉ map ƒë·∫πp h∆°n */
        .game-header { position: relative; z-index: 20; text-shadow: 2px 2px 0 #000; }
        /* ·∫®n b·ªõt c√°c ph·∫ßn th·ª´a khi ·ªü map screen */
        #map-screen { position: relative; z-index: 1; }
    </style>
</head>
<body>

    <div class="game-container">
        <header class="game-header">
            <h1>üå≤ R·ª™NG KH·ªûI ƒê·∫¶U üå≤</h1>
            <p>Ho√†n th√†nh t·ª´ng tr·∫°m ƒë·ªÉ m·ªü l·ªëi ƒëi ti·∫øp!</p>
        </header>

        <div id="map-screen">
            <div class="home-btn-container" style="margin-bottom: 10px; text-align: center;">
                <button class="pixel-btn secondary small" onclick="window.location.href='index.html'">‚¨Ö V·ªÄ TRANG CH·ª¶</button>
            </div>
            
            <div id="level-list" class="world-map-container bg-forest">
                <div style="text-align: center; padding-top: 200px; color: #fff; font-size: 24px;">
                    ‚è≥ ƒêang t·∫£i b·∫£n ƒë·ªì...
                </div>
            </div>
        </div>

        <main id="battle-screen" class="hidden">
            <button id="btn-pause-toggle" class="pixel-btn">‚è∏ MENU</button>
            <div id="pause-modal" class="hidden">
                <div class="pause-content">
                    <h2>T·∫†M D·ª™NG</h2>
                    <button id="btn-resume" class="pixel-btn">TI·∫æP T·ª§C</button>
                    <button id="btn-restart" class="pixel-btn">CH∆†I L·∫†I</button>
                    <button id="btn-menu-map" class="pixel-btn secondary">THO√ÅT RA B·∫¢N ƒê·ªí</button>
                    <button id="btn-menu-home" class="pixel-btn secondary">V·ªÄ TRANG CH·ª¶</button>
                </div>
            </div>
            <div class="status-bar">
                <div class="player-stats">
                    <span>HERO</span>
                    <div class="hp-bar">
                        <div class="hp-fill" id="hero-hp" style="width: 100%;"></div>
                        <span class="hp-text" id="hero-hp-text">100/100</span>
                    </div>
                </div>
                <div class="monster-stats">
                    <span id="monster-name">MONSTER</span>
                    <div class="hp-bar">
                        <div class="hp-fill" id="monster-hp" style="width: 100%;"></div>
                        <span class="hp-text" id="monster-hp-text">100/100</span>
                    </div>
                </div>
            </div>

            <div class="monster-area">
                <div class="character-display">
                    <div class="character-name">HERO</div>
                    <div class="pixel-hero">‚öîÔ∏è</div>
                </div>
                <div class="character-display">
                    <div class="character-name" id="monster-title">BOSS</div>
                    <div class="pixel-monster">üëæ</div>
                </div>
            </div>

            <div class="dialog-box">
                <p id="question-text">...</p>
            </div>

            <div class="player-actions">
                </div>
            
            <button class="pixel-btn secondary hidden" id="btn-back-map" style="margin-top: 10px;">QUAY V·ªÄ B·∫¢N ƒê·ªí</button>
        </main>
    </div>

    <script src="js/core.js"></script>

    <script type="module">
        import { db, collection, getDocs, doc, updateDoc } from './js/firebase-init.js';

        const MAP_ID = "map_rung"; // ƒê·ªïi th√†nh map_city ho·∫∑c map_dungeon ·ªü c√°c file kia

        // 1. H√†m l∆∞u ti·∫øn ƒë·ªô (ƒê∆∞·ª£c core.js g·ªçi khi th·∫Øng)
        window.saveLevelProgress = async function(mapId, levelId) {
            try {
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i Completed l√™n Firebase
                const levelRef = doc(db, "worlds", MAP_ID, "levels", levelId.toString());
                await updateDoc(levelRef, { completed: true });
                console.log(`ƒê√£ l∆∞u ho√†n th√†nh Level ${levelId}`);
                
                // T·∫£i l·∫°i map ƒë·ªÉ m·ªü kh√≥a m√†n m·ªõi
                loadData(); 
            } catch (error) {
                console.error("L·ªói l∆∞u game:", error);
            }
        };

        // 2. H√†m t·∫£i d·ªØ li·ªáu
        async function loadData() {
            try {
                const querySnapshot = await getDocs(collection(db, "worlds", MAP_ID, "levels"));
                const levels = [];
                querySnapshot.forEach((doc) => levels.push(doc.data()));

                if (levels.length > 0) {
                    window.currentMapLevels = levels;
                    // G·ªçi h√†m initMap m·ªõi v·ªõi tham s·ªë MAP_ID (d√πng window. v√¨ ƒë√¢y l√† module script)
                    window.initMap(levels, MAP_ID); 
                } else {
                    document.getElementById("level-list").innerHTML = "<p style='color:white; text-align:center; padding-top:50px;'>‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu map!</p>";
                }
            } catch (error) {
                console.error(error);
                document.getElementById("level-list").innerText = "‚ùå L·ªói k·∫øt n·ªëi!";
            }
        }
        
        loadData();
    </script>
</body>
</html>